<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Alertas y calendario unificado de musicales en España" />
    <title>BroadWatch — Musical Alerts</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/ui/styles.css">
  </head>
  <body>
    <main class="ui-container">
      <section id="events" class="grid" aria-live="polite"></section>
    </main>

    <style>
      /* Minimal styles for expandable musical cards (local, non-invasive) */
      .musicals-grid { padding: 1rem 1rem 3rem; }
      .section-title { font-weight:700; margin: .5rem 0 1rem; }
      .cards-row { display:flex; flex-wrap:wrap; gap:1rem; }
      .cards-row .card { width: 260px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); border-radius:10px; overflow:hidden; cursor:pointer; background:#fff; transition:transform .12s ease, box-shadow .12s ease; }
      .cards-row .card:hover{ transform:translateY(-4px); box-shadow:0 10px 22px rgba(0,0,0,0.08); }
      .cards-row .card .thumb{ height:120px; background-size:cover; background-position:center; }
      .cards-row .card .card-body{ padding:0.75rem; }
      .cards-row .card .card-extra{ max-height:0; overflow:hidden; transition:max-height .28s ease, padding .2s ease; padding:0 .75rem 0; }
      .cards-row .card.expanded .card-extra{ max-height:400px; padding:.5rem .75rem .75rem; }
      .cards-row .card .card-actions{ display:flex; gap:.5rem; align-items:center; margin-top:.5rem; }
      .cards-row .card .card-actions a{ text-decoration:none }
      /* Ensure internal buttons/links are clickable without toggling card */
      .cards-row .card a, .cards-row .card button{ pointer-events:auto; }
    </style>

    <section id="musicals" class="grid musicals-grid" aria-label="Musicales destacados">
      <h2 class="section-title">Musicales destacados</h2>
      <div class="cards-row">
        <article class="musical-card" data-id="wicked">
          <div class="thumb" data-images="/static/fotos/wicked/WICKED1.webp,/static/fotos/wicked/WICKED2.jpg,/static/fotos/wicked/WICKED3.jpg" style="background-image:url('/static/fotos/wicked/WICKED1.webp')" role="img" aria-label="Wicked">
            <div class="thumb-placeholder" aria-hidden="true"></div>
          </div>
          <div class="card-footer">
            <div>
              <div class="title">Wicked</div>
              <div class="status-bar"><span class="pill">Sin cambios</span></div>
            </div>
            <button class="expand-btn" aria-label="Expandir">▾</button>
          </div>
        </article>

        <article class="musical-card" data-id="houdini">
          <div class="thumb" data-images="/static/fotos/Houdini/HOUDINI1.jpg,/static/fotos/Houdini/HOUDINI6.jpg,/static/fotos/Houdini/HOUDINI7.jpg" style="background-image:url('/static/fotos/Houdini/HOUDINI1.jpg')" role="img" aria-label="Houdini">
            <div class="thumb-placeholder" aria-hidden="true"></div>
          </div>
          <div class="card-footer">
            <div>
              <div class="title">Houdini</div>
              <div class="status-bar"><span class="pill">Sin cambios</span></div>
            </div>
            <button class="expand-btn" aria-label="Expandir">▾</button>
          </div>
        </article>

        <article class="musical-card" data-id="les_mis">
          <div class="thumb" data-images="/static/fotos/los_miserables/LESMIS1.jpg,/static/fotos/los_miserables/LESMIS2.jpg,/static/fotos/los_miserables/LESMIS3.png" style="background-image:url('/static/fotos/los_miserables/LESMIS1.jpg')" role="img" aria-label="Les Miserables">
            <div class="thumb-placeholder" aria-hidden="true"></div>
          </div>
          <div class="card-footer">
            <div>
              <div class="title">Los Miserables</div>
              <div class="status-bar"><span class="pill">Sin cambios</span></div>
            </div>
            <button class="expand-btn" aria-label="Expandir">▾</button>
          </div>
        </article>

        <article class="musical-card" data-id="tbom">
          <div class="thumb" data-images="/static/fotos/book_of_mormon/BOM1.jpg,/static/fotos/book_of_mormon/BOM5.jpg,/static/fotos/book_of_mormon/BOM3.jpg" style="background-image:url('/static/fotos/book_of_mormon/BOM1.jpg')" role="img" aria-label="The Book of Mormon">
            <div class="thumb-placeholder" aria-hidden="true"></div>
          </div>
          <div class="card-footer">
            <div>
              <div class="title">The Book of Mormon</div>
              <div class="status-bar"><span class="pill">Sin cambios</span></div>
            </div>
            <button class="expand-btn" aria-label="Expandir">▾</button>
          </div>
        </article>
      </div>

      <div id="musical-details" class="musical-details" aria-live="polite"></div>

      <style>
        /* Cards - updated visual styling to match reference */
        .musicals-grid{ padding:2rem 0; display:flex; flex-direction:column; align-items:center; }
        .musicals-grid .section-title{ font-size:1.25rem; color:#333; margin-bottom:1rem }

        /* center panel for cards */
        .cards-row{ display:flex; gap:1rem; align-items:flex-start; justify-content:center; flex-wrap:wrap; max-width:1180px; margin:0 auto; padding:1.1rem; background:linear-gradient(180deg,#fff,#fff); border-radius:16px }

        /* card */
        .musical-card{ width:300px; border-radius:12px; overflow:hidden; background:#fff; border:1px solid rgba(226, 69, 146, 0.05); box-shadow:0 12px 28px rgba(230,200,220,0.10); cursor:pointer; transition:transform .14s ease, box-shadow .14s ease }
        .musical-card:hover{ transform:translateY(-6px); box-shadow:0 20px 40px rgba(230,200,220,0.14) }
        .musical-card .thumb{ height:140px; background-size:cover; background-position:center; display:flex; align-items:center; justify-content:center; background-color:#fff }
        .musical-card .thumb-placeholder{ width:180px; height:90px; background:#fff; border-radius:10px; box-shadow:0 6px 16px rgba(220,180,200,0.12); }

        .musical-card .card-footer{ display:flex; align-items:center; justify-content:space-between; padding:.75rem .9rem; }
        .musical-card .title{ font-weight:700; color:#ff4da6; font-size:15px }

        /* expand button: pink circular */
        .expand-btn{ border:0; background:#fff; border-radius:18px; width:36px; height:36px; box-shadow:0 3px 8px rgba(0,0,0,0.06); cursor:pointer; color:#ff4da6; font-weight:700 }
        .expand-btn:active{ transform:scale(.98) }

        .musical-card .status-bar{ margin-top:6px }
        .musical-card .pill{ display:inline-block; background:linear-gradient(90deg,#ffdff0,#ffeaf6); color:#c2185b; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600 }

        /* Details area (full-width row) */
        .musical-details{ margin-top:1.25rem; max-width:1180px; margin-left:auto; margin-right:auto }
        .musical-details .detail{ display:flex; gap:1rem; align-items:flex-start; background:#fff; padding:1rem; border-radius:12px; box-shadow:0 10px 34px rgba(230,200,220,0.10) }
        .musical-details .detail .detail-thumb{ width:180px; height:120px; background-size:cover; background-position:center; border-radius:8px; background-color:#fff }
        .musical-details .detail .detail-body{ flex:1 }
        .musical-details .detail h3{ margin:0 0 .25rem 0; color:#333 }
        .musical-details .detail p{ margin:0 0 .5rem 0; color:#666 }
        .musical-details .detail .actions{ display:flex; gap:.5rem; }
        .musical-details .close-detail{ margin-left:.5rem; border:0; background:transparent; cursor:pointer; color:#999 }
      </style>

      <script>
        (function(){
          const data = {
            wicked: {
              title: 'Wicked',
              img: '/static/fotos/wicked/WICKED1.webp',
              desc: 'Un viaje musical por las historias que marcaron una generación.',
              links: [{t:'Sitio',u:'https://wickedelmusical.com/'},{t:'Entradas',u:'https://tickets.wickedelmusical.com/espectaculo/wicked-el-musical/W01'},{t:'Elenco',u:'https://wickedelmusical.com/elenco'}]
            },
            houdini: {
              title: 'Houdini',
              img: '/static/fotos/Houdini/HOUDINI1.jpg',
              desc: 'Información y noticias sobre Houdini. Visita la web oficial para detalles de elenco y venta de entradas.',
              links: [{t:'Sitio',u:'https://www.houdinielmusical.com'}]
            },
            les_mis: {
              title: 'Les Misérables',
              img: '/static/fotos/los_miserables/LESMIS1.jpg',
              desc: 'Clásico musical en una nueva producción. Consulta elenco y fechas desde la web oficial.',
              links: [{t:'Sitio',u:'https://miserableselmusical.es/'},{t:'Entradas',u:'https://tickets.miserableselmusical.es/espectaculo/los-miserables/M01'},{t:'Elenco',u:'https://miserableselmusical.es/elenco'}]
            },
            tbom: {
              title: 'The Book of Mormon',
              img: '/static/fotos/book_of_mormon/BOM1.jpg',
              desc: 'Comedia musical que ha triunfado internacionalmente. Consulta fechas y compra entradas en la web oficial.',
              links: [{t:'Sitio',u:'https://thebookofmormonelmusical.es/'},{t:'Entradas',u:'https://tickets.thebookofmormonelmusical.es/espectaculo/the-book-of-mormon-el-musical/BM01'},{t:'Elenco',u:'https://thebookofmormonelmusical.es/elenco/'}]
            }
          }

          const cards = Array.from(document.querySelectorAll('.musical-card'))
          const details = document.getElementById('musical-details')

          function renderDetail(info){
            if(!info) return
            const linksHtml = info.links.map(l=>`<a class="btn btn-ghost" href="${l.u}" target="_blank" rel="noopener">${l.t}</a>`).join(' ')
            details.innerHTML = `\n              <div class="detail">\n                <div class="detail-thumb" style="background-image:url('${info.img}')"></div>\n                <div class="detail-body">\n                  <h3>${info.title}</h3>\n                  <p>${info.desc}</p>\n                  <div class="actions">${linksHtml}</div>\n                </div>\n                <div><button class="close-detail" aria-label="Cerrar">✕</button></div>\n              </div>\n            `
            details.querySelector('.close-detail').addEventListener('click', ()=>{ details.innerHTML = '' })
            details.scrollIntoView({behavior:'smooth', block:'start'})
          }

          cards.forEach(card=>{
            const id = card.dataset.id
            const btn = card.querySelector('.expand-btn')
            btn.addEventListener('click', (e)=>{
              e.stopPropagation()
              const info = data[id]
              renderDetail(info)
            })
            // clicking the card also expands
            card.addEventListener('click', ()=>{
              const info = data[id]
              renderDetail(info)
            })
          })

          // Initialize lightweight thumbnail slideshows for each card
          document.querySelectorAll('.musical-card .thumb').forEach(thumb => {
            const imgs = (thumb.dataset.images || '').split(',').map(s => s.trim()).filter(Boolean)
            if (!imgs.length) return
            let i = 0
            let intervalId = null
            const setBg = (idx) => thumb.style.backgroundImage = `url('${imgs[idx]}')`
            const placeholder = thumb.querySelector('.thumb-placeholder')
            const start = () => {
              if (placeholder) placeholder.style.display = 'none'
              if (intervalId) return
              intervalId = setInterval(() => {
                i = (i + 1) % imgs.length
                setBg(i)
              }, 2500)
            }
            const stop = () => { if (intervalId) { clearInterval(intervalId); intervalId = null } }
            // start autoplay, pause on hover
            setBg(0)
            start()
            thumb.addEventListener('mouseenter', stop)
            thumb.addEventListener('mouseleave', start)
            // keep reference for potential future cleanup
            thumb.dataset._slideshowRunning = '1'
          })
        })()
      </script>

    <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

    <script>
      // Load events and render cards
      async function loadEvents(){
        try{
          const res = await fetch('/api/events')
          const data = await res.json()
          // remove top cards we don't want (Wicked / Los Miserables)
          const container = document.getElementById('events')
          const filtered = (data || []).filter(e => {
            const t = (e.title || '').toLowerCase()
            // blacklist by keyword
            return !(/wicked|miserabl|los miserabl/i.test(t))
          })

          container.innerHTML = filtered.map(e => {
            const thumb = e.image || (`/static/ui/images/placeholder.png`)
            const availability = e.available ? 'Disponible' : 'Agotado'
            const badgeClass = e.available ? 'badge available' : 'badge sold'
            const dateShort = (e.date || '').split(' ')[0]
            return (`
              <article class="card">
                <div class="thumb" style="background-image:url('${thumb}')" role="img" aria-label="${e.title}"></div>
                <div class="card-body">
                  <div class="card-head">
                    <h3>${e.title}</h3>
                    <span class="date-pill">${dateShort}</span>
                  </div>
                  <p class="meta">${e.place || ''} — ${e.date || ''}</p>
                  <p class="summary">${e.summary || ''}</p>
                  <div class="card-actions">
                    <button class="btn btn-primary">Recordarme</button>
                    <button class="btn btn-ghost" onclick="window.location='/ui/event/${e.id}'">Ver</button>
                    <button class="btn btn-test" onclick="testNotify('${e.id}')">Test Notif</button>
                    <span class="spacer"></span>
                    <span class="${badgeClass}">${availability}</span>
                  </div>
                </div>
              </article>
            `)
          }).join('')
        }catch(err){
          showToast('Error cargando eventos: ' + err, true)
        }
      }
      loadEvents()

      // Trigger a notification via API
      async function testNotify(eventId){
        showToast('Enviando test…')
        console.log('[ui] testNotify ->', eventId)
        try{
          const res = await fetch('/api/notify', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({event_id: eventId})})
          console.log('[ui] /api/notify response', res)
          if(!res.ok) throw new Error('HTTP ' + res.status)
          const j = await res.json()
          console.log('[ui] /api/notify json', j)
          showToast('Notificación enviada: ' + (j.url || eventId))
        }catch(err){
          console.error('[ui] testNotify error', err)
          showToast('Error al enviar test: ' + err, true)
        }
      }

      // Live search filter
      document.getElementById('search').addEventListener('input', (ev) => {
        const q = ev.target.value.toLowerCase().trim()
        document.querySelectorAll('#events .card').forEach(card => {
          const txt = card.innerText.toLowerCase()
          card.style.display = q ? (txt.includes(q) ? '' : 'none') : ''
        })
      })

      // Status poll
      async function refreshStatus(){
        try{
          const r = await fetch('/status')
          const s = await r.json()
          document.getElementById('status-val').innerText = s.running ? (s.paused? 'Paused':'Running') : 'Stopped'
        }catch(e){
          document.getElementById('status-val').innerText = 'Unavailable'
        }
      }
      setInterval(refreshStatus, 5000)
      refreshStatus()

      // Simple toast
      function showToast(msg, isError){
        const t = document.getElementById('toast')
        t.className = 'toast' + (isError ? ' toast-error' : '')
        t.innerText = msg
        t.style.opacity = 1
        setTimeout(()=>{ t.style.opacity = 0 }, 4000)
      }

      // Hero video rotation (lazy-start) with robust error handling
      (function rotateHero(){
        const vids = Array.from(document.querySelectorAll('.hero-video'))
        const dots = Array.from(document.querySelectorAll('#hero-dots .dot'))
        if(!vids.length) return

        // Keep only videos that have a src and a supported type
        const playable = vids.filter(v => {
          const src = v.getAttribute('src') || ''
          if(!src) return false
          // Basic support check (browser may still fail to play if file missing)
          const canMp4 = v.canPlayType && v.canPlayType('video/mp4')
          const canWebm = v.canPlayType && v.canPlayType('video/webm')
          return !!(canMp4 || canWebm)
        })
        if(!playable.length) return

        let i = 0
        playable.forEach((v, idx)=>{
          v.style.display = idx === 0 ? 'block' : 'none'
          if(dots[idx]) dots[idx].classList.toggle('active', idx === 0)
          v.muted = true
          v.preload = 'metadata'
          v.addEventListener('error', (ev) => console.warn('[ui] hero video error', v.src, ev))
        })

        const playSafe = async (videoEl) => {
          try{
            const p = videoEl.play()
            if(p && typeof p.then === 'function') await p
            return true
          }catch(err){
            console.warn('[ui] video play failed for', videoEl.src, err)
            return false
          }
        }

        // Try to play first available
        playSafe(playable[0]).catch(()=>{})

        const interval = setInterval(async () => {
          if(playable.length <= 1){
            // Nothing to rotate
            clearInterval(interval)
            return
          }

          const current = playable[i]
          current.style.display = 'none'
          try{ current.pause(); current.currentTime = 0 }catch(e){}

          i = (i + 1) % playable.length
          const next = playable[i]
          next.style.display = 'block'
          if(dots.length) dots.forEach((d, idx)=> d.classList.toggle('active', idx === i))

          const ok = await playSafe(next)
          if(!ok){
            // Remove failing video so we don't attempt again
            console.warn('[ui] removing failing hero video', next.src)
            playable.splice(i, 1)
            if(playable.length === 0){ clearInterval(interval); return }
            i = i % playable.length
          }
        }, 5000)
      })()
    </script>
  </body>
</html>
