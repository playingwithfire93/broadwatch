<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Alertas y calendario unificado de musicales en España" />
    <title>BroadWatch — Musical Alerts</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/ui/styles.css">
  </head>
  <body>
    </main>

    <style>
      /* Minimal styles for expandable musical cards (local, non-invasive) */
      .musicals-grid { padding: 1rem 1rem 3rem; }
      .section-title { font-weight:700; margin: .5rem 0 1rem; }
      .cards-row { display:flex; flex-wrap:wrap; gap:1rem; }
      .cards-row .card { width: 260px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); border-radius:10px; overflow:hidden; cursor:pointer; background:#fff; transition:transform .12s ease, box-shadow .12s ease; }
      .cards-row .card:hover{ transform:translateY(-4px); box-shadow:0 10px 22px rgba(0,0,0,0.08); }
      .cards-row .card .thumb{ height:120px; background-size:cover; background-position:center; }
      .cards-row .card .card-body{ padding:0.75rem; }
      .cards-row .card .card-extra{ max-height:0; overflow:hidden; transition:max-height .28s ease, padding .2s ease; padding:0 .75rem 0; }
      .cards-row .card.expanded .card-extra{ max-height:400px; padding:.5rem .75rem .75rem; }
      .cards-row .card .card-actions{ display:flex; gap:.5rem; align-items:center; margin-top:.5rem; }
      .cards-row .card .card-actions a{ text-decoration:none }
      /* Ensure internal buttons/links are clickable without toggling card */
      .cards-row .card a, .cards-row .card button{ pointer-events:auto; }
    </style>

    <section id="musicals" class="grid musicals-grid" aria-label="Musicales destacados">
      <h2 class="section-title">Musicales destacados</h2>
      <div class="cards-row">
        <article class="card" data-id="wicked">
          <div class="thumb" style="background-image:url('/static/ui/images/wicked.jpg')" role="img" aria-label="Wicked"></div>
          <div class="card-body">
            <div class="card-head"><h3>Wicked</h3><span class="date-pill">—</span></div>
            <p class="meta">Musical — España</p>
            <div class="card-actions">
              <a class="btn btn-primary" href="https://wickedelmusical.com/" target="_blank" rel="noopener">Sitio</a>
              <a class="btn btn-ghost" href="https://tickets.wickedelmusical.com/espectaculo/wicked-el-musical/W01" target="_blank" rel="noopener">Entradas</a>
            </div>
            <div class="card-extra">
              <p>Un viaje musical por las historias que marcaron una generación. Haz click en los enlaces para visitar web, elenco o comprar entradas.</p>
              <div class="card-actions" style="margin-top:.5rem">
                <a class="btn" href="https://wickedelmusical.com/elenco" target="_blank" rel="noopener">Elenco</a>
                <a class="btn" href="https://tickets.wickedelmusical.com/espectaculo/wicked-el-musical/W01" target="_blank" rel="noopener">Comprar entradas</a>
              </div>
            </div>
          </div>
        </article>

        <article class="card" data-id="houdini">
          <div class="thumb" style="background-image:url('/static/ui/images/houdini.jpg')" role="img" aria-label="Houdini"></div>
          <div class="card-body">
            <div class="card-head"><h3>Houdini</h3><span class="date-pill">—</span></div>
            <p class="meta">Musical — España</p>
            <div class="card-actions">
              <a class="btn btn-primary" href="https://www.houdinielmusical.com" target="_blank" rel="noopener">Sitio</a>
            </div>
            <div class="card-extra">
              <p>Información y noticias sobre Houdini. Visita la web oficial para detalles de elenco y venta de entradas.</p>
              <div class="card-actions" style="margin-top:.5rem">
                <a class="btn" href="https://www.houdinielmusical.com" target="_blank" rel="noopener">Ver sitio</a>
              </div>
            </div>
          </div>
        </article>

        <article class="card" data-id="les_mis">
          <div class="thumb" style="background-image:url('/static/ui/images/les_mis.jpg')" role="img" aria-label="Los Miserables"></div>
          <div class="card-body">
            <div class="card-head"><h3>Les Misérables</h3><span class="date-pill">—</span></div>
            <p class="meta">Musical — España</p>
            <div class="card-actions">
              <a class="btn btn-primary" href="https://miserableselmusical.es/" target="_blank" rel="noopener">Sitio</a>
              <a class="btn btn-ghost" href="https://tickets.miserableselmusical.es/espectaculo/los-miserables/M01" target="_blank" rel="noopener">Entradas</a>
            </div>
            <div class="card-extra">
              <p>Clásico musical en una nueva producción. Consulta elenco y fechas desde la web oficial.</p>
              <div class="card-actions" style="margin-top:.5rem">
                <a class="btn" href="https://miserableselmusical.es/elenco" target="_blank" rel="noopener">Elenco</a>
                <a class="btn" href="https://tickets.miserableselmusical.es/espectaculo/los-miserables/M01" target="_blank" rel="noopener">Comprar entradas</a>
              </div>
            </div>
          </div>
        </article>

        <article class="card" data-id="tbom">
          <div class="thumb" style="background-image:url('/static/ui/images/book_of_mormon.jpg')" role="img" aria-label="The Book of Mormon"></div>
          <div class="card-body">
            <div class="card-head"><h3>The Book of Mormon</h3><span class="date-pill">—</span></div>
            <p class="meta">Musical — España</p>
            <div class="card-actions">
              <a class="btn btn-primary" href="https://thebookofmormonelmusical.es/" target="_blank" rel="noopener">Sitio</a>
              <a class="btn btn-ghost" href="https://tickets.thebookofmormonelmusical.es/espectaculo/the-book-of-mormon-el-musical/BM01" target="_blank" rel="noopener">Entradas</a>
            </div>
            <div class="card-extra">
              <p>Comedia musical que ha triunfado internacionalmente. Consulta fechas y compra entradas en la web oficial.</p>
              <div class="card-actions" style="margin-top:.5rem">
                <a class="btn" href="https://thebookofmormonelmusical.es/elenco/" target="_blank" rel="noopener">Elenco</a>
                <a class="btn" href="https://tickets.thebookofmormonelmusical.es/espectaculo/the-book-of-mormon-el-musical/BM01" target="_blank" rel="noopener">Comprar entradas</a>
              </div>
            </div>
          </div>
        </article>
      </div>
    </section>

    <script>
      (function(){
        const container = document.getElementById('musicals')
        if(!container) return
        const cards = Array.from(container.querySelectorAll('.card'))
        // Accordion: only one open at a time
        cards.forEach(card => {
          // prevent clicks on links/buttons from toggling
          card.querySelectorAll('a, button').forEach(el => el.addEventListener('click', e=> e.stopPropagation()))
          card.addEventListener('click', (e)=>{
            const isExpanded = card.classList.contains('expanded')
            // collapse all
            cards.forEach(c=> c.classList.remove('expanded'))
            // toggle the clicked one (open if it was closed)
            if(!isExpanded) card.classList.add('expanded')
          })
        })
      })()
    </script>

        <article class="card">
          <div class="thumb" style="background-image:url('/static/ui/images/les_mis.jpg')" role="img" aria-label="Los Miserables"></div>
          <div class="card-body">
            <div class="card-head">
              <h3>Les Misérables</h3>
              <span class="date-pill">—</span>
            </div>
            <p class="meta">Musical — España</p>
            <div class="card-actions">
              <a class="btn btn-primary" href="https://miserableselmusical.es/" target="_blank" rel="noopener">Sitio</a>
              <a class="btn btn-primary" href="https://miserableselmusical.es/elenco" target="_blank" rel="noopener">Elenco</a>
              <a class="btn btn-ghost" href="https://tickets.miserableselmusical.es/espectaculo/los-miserables/M01" target="_blank" rel="noopener">Entradas</a>
            </div>
          </div>
        </article>

        <article class="card">
          <div class="thumb" style="background-image:url('/static/ui/images/book_of_mormon.jpg')" role="img" aria-label="The Book of Mormon"></div>
          <div class="card-body">
            <div class="card-head">
              <h3>The Book of Mormon</h3>
              <span class="date-pill">—</span>
            </div>
            <p class="meta">Musical — España</p>
            <div class="card-actions">
              <a class="btn btn-primary" href="https://thebookofmormonelmusical.es/" target="_blank" rel="noopener">Sitio</a>
              <a class="btn btn-primary" href="https://thebookofmormonelmusical.es/elenco" target="_blank" rel="noopener">Elenco</a>
              <a class="btn btn-ghost" href="https://tickets.thebookofmormonelmusical.es/espectaculo/the-book-of-mormon-el-musical/BM01" target="_blank" rel="noopener">Entradas</a>
            </div>
          </div>
        </article>
      </div>
    </section>

    <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

    <script>
      // Load events and render cards
      async function loadEvents(){
        try{
          const res = await fetch('/api/events')
          const data = await res.json()
          const container = document.getElementById('events')
          container.innerHTML = data.map(e => {
            const thumb = e.image || (`/static/ui/images/placeholder.png`)
            const availability = e.available ? 'Disponible' : 'Agotado'
            const badgeClass = e.available ? 'badge available' : 'badge sold'
            const dateShort = (e.date || '').split(' ')[0]
            return (`
              <article class="card">
                <div class="thumb" style="background-image:url('${thumb}')" role="img" aria-label="${e.title}"></div>
                <div class="card-body">
                  <div class="card-head">
                    <h3>${e.title}</h3>
                    <span class="date-pill">${dateShort}</span>
                  </div>
                  <p class="meta">${e.place || ''} — ${e.date || ''}</p>
                  <p class="summary">${e.summary || ''}</p>
                  <div class="card-actions">
                    <button class="btn btn-primary">Recordarme</button>
                    <button class="btn btn-ghost" onclick="window.location='/ui/event/${e.id}'">Ver</button>
                    <button class="btn btn-test" onclick="testNotify('${e.id}')">Test Notif</button>
                    <span class="spacer"></span>
                    <span class="${badgeClass}">${availability}</span>
                  </div>
                </div>
              </article>
            `)
          }).join('')
        }catch(err){
          showToast('Error cargando eventos: ' + err, true)
        }
      }
      loadEvents()

      // Trigger a notification via API
      async function testNotify(eventId){
        showToast('Enviando test…')
        console.log('[ui] testNotify ->', eventId)
        try{
          const res = await fetch('/api/notify', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({event_id: eventId})})
          console.log('[ui] /api/notify response', res)
          if(!res.ok) throw new Error('HTTP ' + res.status)
          const j = await res.json()
          console.log('[ui] /api/notify json', j)
          showToast('Notificación enviada: ' + (j.url || eventId))
        }catch(err){
          console.error('[ui] testNotify error', err)
          showToast('Error al enviar test: ' + err, true)
        }
      }

      // Live search filter
      document.getElementById('search').addEventListener('input', (ev) => {
        const q = ev.target.value.toLowerCase().trim()
        document.querySelectorAll('#events .card').forEach(card => {
          const txt = card.innerText.toLowerCase()
          card.style.display = q ? (txt.includes(q) ? '' : 'none') : ''
        })
      })

      // Status poll
      async function refreshStatus(){
        try{
          const r = await fetch('/status')
          const s = await r.json()
          document.getElementById('status-val').innerText = s.running ? (s.paused? 'Paused':'Running') : 'Stopped'
        }catch(e){
          document.getElementById('status-val').innerText = 'Unavailable'
        }
      }
      setInterval(refreshStatus, 5000)
      refreshStatus()

      // Simple toast
      function showToast(msg, isError){
        const t = document.getElementById('toast')
        t.className = 'toast' + (isError ? ' toast-error' : '')
        t.innerText = msg
        t.style.opacity = 1
        setTimeout(()=>{ t.style.opacity = 0 }, 4000)
      }

      // Hero video rotation (lazy-start) with robust error handling
      (function rotateHero(){
        const vids = Array.from(document.querySelectorAll('.hero-video'))
        const dots = Array.from(document.querySelectorAll('#hero-dots .dot'))
        if(!vids.length) return

        // Keep only videos that have a src and a supported type
        const playable = vids.filter(v => {
          const src = v.getAttribute('src') || ''
          if(!src) return false
          // Basic support check (browser may still fail to play if file missing)
          const canMp4 = v.canPlayType && v.canPlayType('video/mp4')
          const canWebm = v.canPlayType && v.canPlayType('video/webm')
          return !!(canMp4 || canWebm)
        })
        if(!playable.length) return

        let i = 0
        playable.forEach((v, idx)=>{
          v.style.display = idx === 0 ? 'block' : 'none'
          if(dots[idx]) dots[idx].classList.toggle('active', idx === 0)
          v.muted = true
          v.preload = 'metadata'
          v.addEventListener('error', (ev) => console.warn('[ui] hero video error', v.src, ev))
        })

        const playSafe = async (videoEl) => {
          try{
            const p = videoEl.play()
            if(p && typeof p.then === 'function') await p
            return true
          }catch(err){
            console.warn('[ui] video play failed for', videoEl.src, err)
            return false
          }
        }

        // Try to play first available
        playSafe(playable[0]).catch(()=>{})

        const interval = setInterval(async () => {
          if(playable.length <= 1){
            // Nothing to rotate
            clearInterval(interval)
            return
          }

          const current = playable[i]
          current.style.display = 'none'
          try{ current.pause(); current.currentTime = 0 }catch(e){}

          i = (i + 1) % playable.length
          const next = playable[i]
          next.style.display = 'block'
          if(dots.length) dots.forEach((d, idx)=> d.classList.toggle('active', idx === i))

          const ok = await playSafe(next)
          if(!ok){
            // Remove failing video so we don't attempt again
            console.warn('[ui] removing failing hero video', next.src)
            playable.splice(i, 1)
            if(playable.length === 0){ clearInterval(interval); return }
            i = i % playable.length
          }
        }, 5000)
      })()
    </script>
  </body>
</html>
