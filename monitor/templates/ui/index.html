<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Alertas y calendario unificado de musicales en España" />
    <title>BroadWatch — Musical Alerts</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/ui/styles.css">
  </head>
  <body>
    <header class="ui-header">
      <div class="header-left">
        <a href="/ui" class="logo">BroadWatch</a>
        <div class="tag">Musical Alerts · España</div>
      </div>
      <div class="header-right">
        <input id="search" class="search" placeholder="Buscar musical, ciudad o fecha..." aria-label="Buscar" />
        <div id="status" class="status-pill">Estado: <strong id="status-val">—</strong></div>
      </div>
    </header>

    <section class="hero">
      <div class="hero-inner">
        <div class="hero-text">
          <h1>Últimas novedades en musicales</h1>
          <p>Recibe alertas y consulta el calendario unificado de espectáculos.</p>
        </div>
        <div class="hero-videos" id="hero-videos">
          <video class="hero-video" muted playsinline preload="metadata" loop src="/static/ui/videos/video1.mp4"></video>
          <video class="hero-video" muted playsinline preload="metadata" loop src="/static/ui/videos/video2.mp4"></video>
          <video class="hero-video" muted playsinline preload="metadata" loop src="/static/ui/videos/video3.mp4"></video>
        </div>
        <div class="hero-dots" id="hero-dots" aria-hidden="true">
          <span class="dot active" data-index="0"></span>
          <span class="dot" data-index="1"></span>
          <span class="dot" data-index="2"></span>
        </div>
      </div>
    </section>

    <main class="ui-container">
      <section id="events" class="grid" aria-live="polite"></section>
    </main>

    <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

    <script>
      // Load events and render cards
      async function loadEvents(){
        try{
          const res = await fetch('/api/events')
          const data = await res.json()
          const container = document.getElementById('events')
          container.innerHTML = data.map(e => {
            const thumb = e.image || (`/static/ui/images/placeholder.png`)
            const availability = e.available ? 'Disponible' : 'Agotado'
            const badgeClass = e.available ? 'badge available' : 'badge sold'
            const dateShort = (e.date || '').split(' ')[0]
            return (`
              <article class="card">
                <div class="thumb" style="background-image:url('${thumb}')" role="img" aria-label="${e.title}"></div>
                <div class="card-body">
                  <div class="card-head">
                    <h3>${e.title}</h3>
                    <span class="date-pill">${dateShort}</span>
                  </div>
                  <p class="meta">${e.place || ''} — ${e.date || ''}</p>
                  <p class="summary">${e.summary || ''}</p>
                  <div class="card-actions">
                    <button class="btn btn-primary">Recordarme</button>
                    <button class="btn btn-ghost" onclick="window.location='/ui/event/${e.id}'">Ver</button>
                    <button class="btn btn-test" onclick="testNotify('${e.id}')">Test Notif</button>
                    <span class="spacer"></span>
                    <span class="${badgeClass}">${availability}</span>
                  </div>
                </div>
              </article>
            `)
          }).join('')
        }catch(err){
          showToast('Error cargando eventos: ' + err, true)
        }
      }
      loadEvents()

      // Trigger a notification via API
      async function testNotify(eventId){
        showToast('Enviando test…')
        console.log('[ui] testNotify ->', eventId)
        try{
          const res = await fetch('/api/notify', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({event_id: eventId})})
          console.log('[ui] /api/notify response', res)
          if(!res.ok) throw new Error('HTTP ' + res.status)
          const j = await res.json()
          console.log('[ui] /api/notify json', j)
          showToast('Notificación enviada: ' + (j.url || eventId))
        }catch(err){
          console.error('[ui] testNotify error', err)
          showToast('Error al enviar test: ' + err, true)
        }
      }

      // Live search filter
      document.getElementById('search').addEventListener('input', (ev) => {
        const q = ev.target.value.toLowerCase().trim()
        document.querySelectorAll('#events .card').forEach(card => {
          const txt = card.innerText.toLowerCase()
          card.style.display = q ? (txt.includes(q) ? '' : 'none') : ''
        })
      })

      // Status poll
      async function refreshStatus(){
        try{
          const r = await fetch('/status')
          const s = await r.json()
          document.getElementById('status-val').innerText = s.running ? (s.paused? 'Paused':'Running') : 'Stopped'
        }catch(e){
          document.getElementById('status-val').innerText = 'Unavailable'
        }
      }
      setInterval(refreshStatus, 5000)
      refreshStatus()

      // Simple toast
      function showToast(msg, isError){
        const t = document.getElementById('toast')
        t.className = 'toast' + (isError ? ' toast-error' : '')
        t.innerText = msg
        t.style.opacity = 1
        setTimeout(()=>{ t.style.opacity = 0 }, 4000)
      }

      // Hero video rotation (lazy-start) with robust error handling
      (function rotateHero(){
        const vids = Array.from(document.querySelectorAll('.hero-video'))
        const dots = Array.from(document.querySelectorAll('#hero-dots .dot'))
        if(!vids.length) return

        // Keep only videos that have a src and a supported type
        const playable = vids.filter(v => {
          const src = v.getAttribute('src') || ''
          if(!src) return false
          // Basic support check (browser may still fail to play if file missing)
          const canMp4 = v.canPlayType && v.canPlayType('video/mp4')
          const canWebm = v.canPlayType && v.canPlayType('video/webm')
          return !!(canMp4 || canWebm)
        })
        if(!playable.length) return

        let i = 0
        playable.forEach((v, idx)=>{
          v.style.display = idx === 0 ? 'block' : 'none'
          if(dots[idx]) dots[idx].classList.toggle('active', idx === 0)
          v.muted = true
          v.preload = 'metadata'
          v.addEventListener('error', (ev) => console.warn('[ui] hero video error', v.src, ev))
        })

        const playSafe = async (videoEl) => {
          try{
            const p = videoEl.play()
            if(p && typeof p.then === 'function') await p
            return true
          }catch(err){
            console.warn('[ui] video play failed for', videoEl.src, err)
            return false
          }
        }

        // Try to play first available
        playSafe(playable[0]).catch(()=>{})

        const interval = setInterval(async () => {
          if(playable.length <= 1){
            // Nothing to rotate
            clearInterval(interval)
            return
          }

          const current = playable[i]
          current.style.display = 'none'
          try{ current.pause(); current.currentTime = 0 }catch(e){}

          i = (i + 1) % playable.length
          const next = playable[i]
          next.style.display = 'block'
          if(dots.length) dots.forEach((d, idx)=> d.classList.toggle('active', idx === i))

          const ok = await playSafe(next)
          if(!ok){
            // Remove failing video so we don't attempt again
            console.warn('[ui] removing failing hero video', next.src)
            playable.splice(i, 1)
            if(playable.length === 0){ clearInterval(interval); return }
            i = i % playable.length
          }
        }, 5000)
      })()
    </script>
  </body>
</html>
